---
description: |
  Regras completas para desenvolvimento do Mec√¢nica365 Backend.
  Inclui: Padr√µes de cria√ß√£o de m√≥dulos, Boas pr√°ticas, Anti-patterns, 
  Processo de desenvolvimento, Docker, Git, Testes, e muito mais.
alwaysApply: true
---

# üìê Regras Completas - Mec√¢nica365 Backend

**√öltima atualiza√ß√£o:** 01/12/2025  
**Status:** Ativo - Obrigat√≥rio para todo desenvolvimento

---

## üéØ PADR√ïES DE CRIA√á√ÉO DE M√ìDULOS

### ETAPA 1 ‚Äî Planejamento
**Antes de criar qualquer arquivo, voc√™ define:**

1. **Responsabilidade √∫nica do m√≥dulo**
   - Exemplo: `auth` (login, tokens, refresh), `user` (dados do usu√°rio)
   - ‚ö†Ô∏è **Regra:** Se tiver mais de 1 responsabilidade ‚Üí divida em mais m√≥dulos

### ETAPA 2 ‚Äî Defini√ß√£o do Contrato (API / Interface)
**Antes do c√≥digo, voc√™ define o que o m√≥dulo exp√µe:**

**Para backend:**
- Endpoints
- Schemas
- Events
- Filas/topics
- DTOs
- Use cases
- Valida√ß√µes

**üëâ Voc√™ escreve o contrato sem implementar nada.**

### ETAPA 3 ‚Äî Estrutura da Pasta do M√≥dulo
**Padr√£o recomendado:**
```
/module-name
    /domain
        entities/
        value-objects/
        services/
    /application
        use-cases/
        dto/
    /infra
        http/
        prisma/
        models/
        repositories/
    /tests
    index.ts
```

### ETAPA 4 ‚Äî Cria√ß√£o das Entidades (Domain)
- Entidades (User, Product, Machine)
- Regras de neg√≥cio
- Valida√ß√µes
- Value objects
- Services de dom√≠nio

**‚ö†Ô∏è Aqui n√£o existe banco de dados nem http ainda.**

### ETAPA 5 ‚Äî Criar Use Cases (Application Layer)
**Cada caso de uso √© isolado:**
- CreateUser, UpdateUser, DeleteUser, ListUsers, LoginUser

**Cada use case:**
- Recebe um DTO
- Executa a l√≥gica da entidade
- Chama reposit√≥rios via interface
- Retorna resultado ou exce√ß√£o

### ETAPA 6 ‚Äî Implementar Infraestrutura
- Prisma (ORM)
- Reposit√≥rio real
- Controllers
- Rotas
- Kafka/Rabbit
- Cache Redis
- Filas
- Webhooks

### ETAPA 7 ‚Äî Testes
**Crie pelo menos:**
- **Unit√°rios:** entidades, services, use-cases
- **Integra√ß√£o:** db, http, mensagens
- **E2E:** (opcional, mas recomendado em SaaS)
- **M√≠nimo 80% de cobertura** para c√≥digo cr√≠tico

### ETAPA 8 ‚Äî Documenta√ß√£o
- README
- Fluxos
- Diagramas
- Contratos
- Decis√µes arquiteturais

### ETAPA 9 ‚Äî Versionamento e Integra√ß√£o
- CI/CD
- Testes autom√°ticos
- Gera√ß√£o autom√°tica de documenta√ß√£o
- Valida√ß√£o de contratos
- Lint
- Verifica√ß√£o do padr√£o de pastas
- **Registrar no `app.module.ts`**

### ETAPA 10 ‚Äî Publica√ß√£o / Integra√ß√£o Autom√°tica
- Dockerfile
- Helm chart
- Version bump
- Tag autom√°tica
- **Integra√ß√£o autom√°tica com outros m√≥dulos**

---

## ‚úÖ CHECKLIST DE CONFORMIDADE (por M√≥dulo)

Antes de considerar um m√≥dulo completo, verificar:

- [ ] Responsabilidade √∫nica e bem definida
- [ ] Contrato/Interface documentado
- [ ] Estrutura de pastas seguindo padr√£o
- [ ] Entidades de dom√≠nio criadas
- [ ] Use cases implementados
- [ ] Infraestrutura conectada
- [ ] Testes unit√°rios (m√≠nimo 80% cobertura)
- [ ] Testes de integra√ß√£o
- [ ] README completo
- [ ] Integrado no sistema principal (`app.module.ts`)
- [ ] Lint passando
- [ ] TypeScript sem erros
- [ ] Build passando
- [ ] **Push feito para reposit√≥rio**
- [ ] **Backend reiniciado no container**

---

## ‚ùå ANTI-PATTERNS (O que N√ÉO fazer)

### 1. Imports N√£o Utilizados
**‚ùå ERRADO:**
```typescript
import { ConflictException, BadRequestException, Logger } from '@nestjs/common';
// ConflictException nunca √© usado
```

**‚úÖ CORRETO:**
```typescript
import { BadRequestException, Logger } from '@nestjs/common';
```

**Como evitar:**
- Execute `npm run lint -- --fix` para corre√ß√£o autom√°tica
- Revise imports antes de fazer commit

### 2. Vari√°veis N√£o Utilizadas
**‚ùå ERRADO:**
```typescript
const subscription = await this.prisma.subscription.findFirst({...});
// subscription nunca √© usado depois
```

**‚úÖ CORRETO:**
```typescript
await this.prisma.subscription.findFirst({...});
// Se n√£o precisa do valor, n√£o atribua a uma vari√°vel
```

**Como evitar:**
- Remova vari√°veis que n√£o s√£o usadas
- Para par√¢metros n√£o usados, prefixe com `_`: `_email: string`

### 3. Uso de `any` Desnecess√°rio
**‚ùå ERRADO:**
```typescript
const plan = metadata.plan as any;
const updateData: any = {};
const featureMatrix = (this.featureFlagsService as any).featureMatrix;
```

**‚úÖ CORRETO:**
```typescript
const plan = metadata.plan as SubscriptionPlan;
const updateData: Prisma.SubscriptionUpdateInput = {};
const planFeatures = this.featureFlagsService.getEnabledFeaturesForPlan(plan);
```

**Como evitar:**
- Defina tipos apropriados para todas as vari√°veis
- Use `unknown` ao inv√©s de `any` quando o tipo √© realmente desconhecido
- Use tipos do Prisma (`Prisma.ModelUpdateInput`) ao inv√©s de `any`
- Crie m√©todos p√∫blicos ao inv√©s de acessar propriedades privadas via type casting
- **ESLint est√° configurado para converter `any` para `unknown` automaticamente**

### 4. Acesso Direto a `error.message` e `error.stack`
**‚ùå ERRADO:**
```typescript
catch (error: any) {
  this.logger.error(`Erro: ${error.message}`, error.stack);
}
```

**‚úÖ CORRETO:**
```typescript
import { getErrorMessage, getErrorStack } from '@common/utils/error.utils';

catch (error: unknown) {
  this.logger.error(
    `Erro: ${getErrorMessage(error)}`,
    getErrorStack(error),
  );
}
```

**Como evitar:**
- **SEMPRE use `unknown` para erros capturados, nunca `any`**
- Use fun√ß√µes helper `getErrorMessage()` e `getErrorStack()` para tratamento seguro

### 5. `await` em M√©todos N√£o-Async
**‚ùå ERRADO:**
```typescript
async getAvailablePlans(): Promise<any[]> {
  return [...]; // M√©todo n√£o precisa ser async
}
```

**‚úÖ CORRETO:**
```typescript
getAvailablePlans(): Array<{...}> {
  return [...]; // M√©todo s√≠ncrono
}
```

**Como evitar:**
- Remova `async` de m√©todos que n√£o usam `await`
- Use tipos de retorno expl√≠citos

### 6. Template Literals com Objetos
**‚ùå ERRADO:**
```typescript
const url = `https://example.com/${session.invoice}`;
// session.invoice pode ser um objeto, n√£o uma string
```

**‚úÖ CORRETO:**
```typescript
const invoiceId = typeof session.invoice === 'string' 
  ? session.invoice 
  : session.invoice?.toString() || '';
const url = `https://example.com/${invoiceId}`;
```

**Como evitar:**
- Sempre verifique o tipo antes de usar em template literals
- Use type guards para garantir tipos corretos
- **Nunca use `String()` diretamente em valores que podem ser objetos**

### 7. Acesso a Propriedades Privadas Via Type Casting
**‚ùå ERRADO:**
```typescript
const featureMatrix = (this.featureFlagsService as any).featureMatrix;
```

**‚úÖ CORRETO:**
```typescript
// Criar m√©todo p√∫blico no FeatureFlagsService:
getEnabledFeaturesForPlan(plan: string): Record<string, FeatureConfig> {
  return this.featureMatrix[plan] || {};
}

// Usar o m√©todo p√∫blico:
const planFeatures = this.featureFlagsService.getEnabledFeaturesForPlan(plan);
```

**Como evitar:**
- Nunca acesse propriedades privadas via `(service as any).property`
- Crie m√©todos p√∫blicos quando necess√°rio

---

## ‚úÖ BOAS PR√ÅTICAS

### 1. Limpeza Regular de C√≥digo
- Execute `npm run lint` antes de cada commit
- Use `npm run lint -- --fix` para corre√ß√µes autom√°ticas
- Revise warnings e erros regularmente

### 2. Type Safety
- Sempre use tipos expl√≠citos
- Evite `any` - use `unknown` quando necess√°rio
- Use type guards para valida√ß√£o de tipos
- **Use tipos do Prisma (`Prisma.ModelUpdateInput`, `Prisma.ModelCreateInput`) ao inv√©s de `any`**
- **Crie m√©todos p√∫blicos ao inv√©s de acessar propriedades privadas via type casting**
- **Remova `async` de m√©todos que n√£o usam `await`**

### 3. Organiza√ß√£o de Imports
- Agrupe imports por origem (NestJS, bibliotecas externas, m√≥dulos locais)
- Remova imports n√£o utilizados
- Use path aliases (`@modules/*`, `@core/*`) para imports locais

### 4. Nomenclatura
- Use nomes descritivos para vari√°veis e fun√ß√µes
- Prefixe par√¢metros n√£o usados com `_`: `_email: string`
- Use constantes para valores m√°gicos

### 5. Tratamento de Erros
- Sempre trate erros adequadamente
- Use tipos espec√≠ficos de exce√ß√£o (NotFoundException, BadRequestException, etc.)
- Log erros com contexto suficiente
- **SEMPRE use `unknown` para erros capturados, nunca `any`**
- **Use fun√ß√µes helper `getErrorMessage()` e `getErrorStack()` para acesso seguro**

### 6. Testes
- Escreva testes para todas as funcionalidades
- Mantenha mocks atualizados
- Execute testes antes de fazer commit
- **Use type assertions em testes E2E** para evitar warnings de `any`
- **Tipar `app.getHttpServer()` como `App`** em testes com Supertest
- **Tipar `response.body`** com interfaces espec√≠ficas ao inv√©s de `any`

**Exemplo de teste E2E tipado:**
```typescript
import type { App } from 'supertest/types';

const response = await request(app.getHttpServer() as App)
  .post('/api/auth/login')
  .send({ email: 'test@test.com', password: 'password' })
  .expect(200);

const body = response.body as {
  accessToken: string;
  refreshToken: string;
  user: { email: string };
};

expect(body.accessToken).toBeDefined();
```

### 7. Warnings de Type Safety em Testes
**Em testes, √© aceit√°vel usar `any` para mocks, mas com supress√µes espec√≠ficas:**

```typescript
// eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/no-unsafe-assignment
const mockService = service as any;
// eslint-disable-next-line @typescript-eslint/no-unsafe-call, @typescript-eslint/no-unsafe-member-access
mockService.stripe.checkout.sessions.list.mockResolvedValue({...});
```

**Como evitar:**
- Use supress√µes do ESLint apenas onde necess√°rio
- Seja espec√≠fico: adicione apenas as regras que realmente geram warnings
- Prefira supress√µes inline (`// eslint-disable-next-line`) ao inv√©s de desabilitar regras globalmente

---

## üê≥ DOCKER E CONTAINERS

### Comandos Essenciais

**Subir containers:**
```bash
docker-compose up -d
```

**Parar containers:**
```bash
docker-compose down
```

**Ver logs:**
```bash
docker-compose logs -f backend
```

**Reiniciar backend (OBRIGAT√ìRIO ap√≥s mudan√ßas):**
```bash
docker-compose restart backend
# OU
docker-compose up -d --force-recreate backend
```

**Rebuild da imagem:**
```bash
docker-compose build backend
docker-compose up -d backend
```

**Executar comandos no container:**
```bash
docker-compose exec backend npm run lint
docker-compose exec backend npm run test
docker-compose exec backend npm run build
```

**Acessar PostgreSQL:**
```bash
docker-compose exec postgres psql -U mecanica365 -d mecanica365_db
```

**Acessar Redis CLI:**
```bash
docker-compose exec redis redis-cli
```

### ‚ö†Ô∏è REGRA CR√çTICA: Reiniciar Backend Ap√≥s Mudan√ßas

**SEMPRE reinicie o backend no container ap√≥s:**
- ‚úÖ Mudan√ßas em c√≥digo TypeScript
- ‚úÖ Mudan√ßas em DTOs
- ‚úÖ Mudan√ßas em Services
- ‚úÖ Mudan√ßas em Controllers
- ‚úÖ Mudan√ßas em Modules
- ‚úÖ Mudan√ßas no `app.module.ts`
- ‚úÖ Mudan√ßas no schema Prisma (ap√≥s migration)
- ‚úÖ Mudan√ßas em configura√ß√µes
- ‚úÖ Qualquer altera√ß√£o que afete o runtime

**Comando:**
```bash
docker-compose restart backend
```

**Verificar se reiniciou corretamente:**
```bash
docker-compose logs backend --tail 50
```

---

## üîÑ PROCESSO DE DESENVOLVIMENTO

### Fluxo Completo (OBRIGAT√ìRIO)

1. **Antes de come√ßar:**
   - [ ] Ler documenta√ß√£o do m√≥dulo/feature
   - [ ] Verificar se h√° TODOs relacionados
   - [ ] Verificar depend√™ncias

2. **Durante desenvolvimento:**
   - [ ] Seguir padr√µes de cria√ß√£o de m√≥dulos (10 etapas)
   - [ ] Seguir boas pr√°ticas e evitar anti-patterns
   - [ ] Executar `npm run lint` frequentemente
   - [ ] Executar `npm run build` para verificar erros TypeScript
   - [ ] Escrever testes enquanto desenvolve

3. **Antes de commit:**
   - [ ] `npm run lint` n√£o retorna erros
   - [ ] `npm run test` passa todos os testes
   - [ ] `npm run build` compila sem erros
   - [ ] Imports n√£o utilizados foram removidos
   - [ ] Vari√°veis n√£o utilizadas foram removidas
   - [ ] Tipos est√£o corretos (sem `any` desnecess√°rio)
   - [ ] Tratamento de erros est√° adequado
   - [ ] C√≥digo est√° documentado quando necess√°rio

4. **Ap√≥s commit (OBRIGAT√ìRIO):**
   - [ ] **Fazer push para reposit√≥rio**
   - [ ] **Reiniciar backend no container: `docker-compose restart backend`**
   - [ ] **Verificar logs: `docker-compose logs backend --tail 50`**
   - [ ] **Verificar se aplica√ß√£o est√° rodando: `docker-compose ps`**

5. **Revis√£o de c√≥digo:**
   - [ ] Verificar se segue padr√µes de cria√ß√£o de m√≥dulos
   - [ ] Verificar se segue boas pr√°ticas
   - [ ] Verificar se n√£o tem anti-patterns
   - [ ] Verificar se testes est√£o passando
   - [ ] Verificar se build est√° passando
   - [ ] Verificar se lint est√° passando
   - [ ] Verificar se documenta√ß√£o est√° atualizada

---

## üìã CHECKLIST ANTES DE COMMIT

- [ ] `npm run lint` n√£o retorna erros
- [ ] `npm run test` passa todos os testes
- [ ] `npm run build` compila sem erros
- [ ] Imports n√£o utilizados foram removidos
- [ ] Vari√°veis n√£o utilizadas foram removidas
- [ ] Tipos est√£o corretos (sem `any` desnecess√°rio)
- [ ] Tratamento de erros est√° adequado
- [ ] C√≥digo est√° documentado quando necess√°rio
- [ ] Testes foram escritos (m√≠nimo 80% cobertura para c√≥digo cr√≠tico)
- [ ] README atualizado (se aplic√°vel)

---

## üìã CHECKLIST AP√ìS COMMIT (OBRIGAT√ìRIO)

- [ ] **Push feito para reposit√≥rio**
- [ ] **Backend reiniciado no container: `docker-compose restart backend`**
- [ ] **Logs verificados: `docker-compose logs backend --tail 50`**
- [ ] **Aplica√ß√£o est√° rodando: `docker-compose ps`**
- [ ] **Health check passando: Verificar `/api/health`**

---

## üîß FERRAMENTAS E COMANDOS √öTEIS

### Linting e Build
```bash
# Verificar erros de linting
npm run lint

# Corrigir erros automaticamente
npm run lint -- --fix

# Verificar apenas um arquivo
npm run lint src/modules/core/onboarding/onboarding.service.ts

# Build do projeto
npm run build

# Verificar tipos TypeScript sem compilar
npx tsc --noEmit
```

### Testes
```bash
# Executar todos os testes
npm run test

# Executar testes em modo watch
npm run test:watch

# Executar testes com cobertura
npm run test:cov

# Executar testes E2E
npm run test:e2e
```

### Docker
```bash
# Subir containers
docker-compose up -d

# Parar containers
docker-compose down

# Ver logs
docker-compose logs -f backend

# Reiniciar backend (OBRIGAT√ìRIO ap√≥s mudan√ßas)
docker-compose restart backend

# Rebuild da imagem
docker-compose build backend
docker-compose up -d backend

# Executar comando no container
docker-compose exec backend npm run lint
docker-compose exec backend npm run test
docker-compose exec backend npm run build
```

### Prisma
```bash
# Gerar Prisma Client
npm run prisma:generate

# Criar migration
npm run prisma:migrate

# Executar migration no container
docker-compose exec backend npx prisma migrate dev

# Abrir Prisma Studio
npm run prisma:studio
```

### Git
```bash
# Verificar status
git status

# Adicionar arquivos
git add .

# Commit
git commit -m "feat: descri√ß√£o da mudan√ßa"

# Push (OBRIGAT√ìRIO ap√≥s commit)
git push

# Verificar branch atual
git branch
```

---

## üéØ M√ìDULOS PRIORIT√ÅRIOS PARA IMPLEMENTA√á√ÉO

### Prioridade Alta üî¥

1. **AppointmentsModule**
   - Schema Prisma j√° existe
   - Implementar Service, Controller, DTOs
   - Integra√ß√£o autom√°tica ap√≥s aprova√ß√£o de or√ßamento

2. **AttachmentsModule**
   - Criar model `Attachment` no Prisma
   - Sistema de upload estruturado
   - Substituir arrays de strings por refer√™ncias

3. **ChecklistsModule**
   - Criar do zero (schema + implementa√ß√£o)
   - Templates de checklist
   - Valida√ß√£o antes de finalizar

### Prioridade M√©dia üü°

4. **JobsModule** (Bull + Redis)
5. **RateLimitingModule** (Throttler)
6. **WebhooksModule**
7. **InvoicingModule**
8. **PaymentsModule**

### Prioridade Baixa üü¢

9. **ReportsModule**
10. **SuppliersModule**
11. **TemplatesModule**
12. **ExportImportModule**

---

## üìä ESTAT√çSTICAS E METAS

### Metas de Qualidade
- ‚úÖ **Zero erros de linting** antes de cada commit
- ‚úÖ **Zero warnings de linting** antes de cada commit
- ‚úÖ **Build passando** sem erros
- ‚úÖ **Type safety** em 100% do c√≥digo
- ‚úÖ **80% de cobertura de testes** para c√≥digo cr√≠tico

### Status Atual
- ‚úÖ **0 erros** de linting
- ‚úÖ **0 warnings** de linting
- ‚úÖ **Build passando** sem erros
- ‚úÖ **Type safety** em 100% do c√≥digo
- ‚úÖ **ESLint configurado** para bloquear `any` explicitamente
- ‚úÖ **Testes E2E** completamente tipados
- ‚úÖ **Testes unit√°rios** com supress√µes ESLint apropriadas para mocks

---

## üîÑ WORKFLOW COMPLETO DE DESENVOLVIMENTO

### 1. Planejamento
- [ ] Definir responsabilidade do m√≥dulo
- [ ] Criar contrato/interface
- [ ] Verificar depend√™ncias

### 2. Desenvolvimento
- [ ] Criar estrutura de pastas
- [ ] Criar entidades de dom√≠nio
- [ ] Criar use cases
- [ ] Implementar infraestrutura
- [ ] Escrever testes (enquanto desenvolve)

### 3. Valida√ß√£o
- [ ] Executar `npm run lint`
- [ ] Executar `npm run build`
- [ ] Executar `npm run test`
- [ ] Verificar cobertura de testes

### 4. Documenta√ß√£o
- [ ] Atualizar README
- [ ] Documentar fluxos
- [ ] Documentar decis√µes arquiteturais

### 5. Integra√ß√£o
- [ ] Registrar no `app.module.ts`
- [ ] Verificar lint, build, testes
- [ ] **Fazer commit**
- [ ] **Fazer push**
- [ ] **Reiniciar backend: `docker-compose restart backend`**
- [ ] **Verificar logs: `docker-compose logs backend --tail 50`**

### 6. Revis√£o
- [ ] Verificar se segue padr√µes
- [ ] Verificar se segue boas pr√°ticas
- [ ] Verificar se n√£o tem anti-patterns
- [ ] Verificar se testes est√£o passando
- [ ] Verificar se aplica√ß√£o est√° rodando

---

## ‚ö†Ô∏è REGRAS CR√çTICAS (NUNCA ESQUECER)

1. **SEMPRE reiniciar backend ap√≥s mudan√ßas:**
   ```bash
   docker-compose restart backend
   ```

2. **SEMPRE fazer push ap√≥s commit:**
   ```bash
   git push
   ```

3. **SEMPRE verificar logs ap√≥s reiniciar:**
   ```bash
   docker-compose logs backend --tail 50
   ```

4. **SEMPRE executar lint antes de commit:**
   ```bash
   npm run lint
   ```

5. **SEMPRE executar build antes de commit:**
   ```bash
   npm run build
   ```

6. **SEMPRE executar testes antes de commit:**
   ```bash
   npm run test
   ```

7. **NUNCA usar `any` - use `unknown` quando necess√°rio**

8. **NUNCA acessar propriedades privadas via `(service as any).property`**

9. **SEMPRE usar `unknown` para erros capturados, nunca `any`**

10. **SEMPRE usar fun√ß√µes helper `getErrorMessage()` e `getErrorStack()` para erros**

---

## üìù NOTAS IMPORTANTES

### Sobre M√≥dulos
- **AppointmentsModule:** Schema Prisma j√° existe, apenas implementar Service, Controller, DTOs
- **AttachmentsModule:** Substituir arrays de strings (`inspectionPhotos`) por refer√™ncias ao model `Attachment`
- **ChecklistsModule:** Criar do zero, incluindo schema Prisma

### Sobre Docker
- Backend roda em Docker
- Sempre reiniciar ap√≥s mudan√ßas em c√≥digo
- Verificar logs ap√≥s reiniciar
- Usar `docker-compose exec backend` para executar comandos

### Sobre Git
- Sempre fazer push ap√≥s commit
- Usar mensagens de commit descritivas
- Verificar status antes de commit

### Sobre Testes
- M√≠nimo 80% de cobertura para c√≥digo cr√≠tico
- Escrever testes enquanto desenvolve
- Executar testes antes de commit

---

## üéØ RESUMO R√ÅPIDO PARA USO DI√ÅRIO

1. ‚úÖ Seguir padr√µes de cria√ß√£o de m√≥dulos (10 etapas)
2. ‚úÖ Seguir boas pr√°ticas e evitar anti-patterns
3. ‚úÖ Executar lint, build, testes antes de commit
4. ‚úÖ Fazer commit e push
5. ‚úÖ **Reiniciar backend: `docker-compose restart backend`**
6. ‚úÖ **Verificar logs: `docker-compose logs backend --tail 50`**
7. ‚úÖ Verificar se aplica√ß√£o est√° rodando

---

**√öltima atualiza√ß√£o:** 01/12/2025
